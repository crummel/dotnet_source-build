From 59cec0ae3ffd8b3129e5db5bddce74c1eec297c8 Mon Sep 17 00:00:00 2001
From: Chris Rummel <crummel@microsoft.com>
Date: Fri, 22 Sep 2017 14:58:18 -0500
Subject: [PATCH] Fix the Roslyn restore. Need to condition the VSSDK import on
 the file existing.

---
 NuGet.Config                                       |  5 +-
 build/Targets/Settings.props                       |  3 +-
 .../Microsoft.CodeAnalysis.Build.Tasks.nuspec      | 45 ++++++------
 src/NuGet/Microsoft.CodeAnalysis.CSharp.nuspec     |  5 +-
 src/NuGet/Microsoft.CodeAnalysis.Common.nuspec     | 84 +++++++++++-----------
 src/NuGet/Microsoft.CodeAnalysis.Compilers.nuspec  |  5 +-
 .../Microsoft.CodeAnalysis.VisualBasic.nuspec      |  5 +-
 src/NuGet/Microsoft.Net.Compilers.netcore.nuspec   | 10 +--
 8 files changed, 78 insertions(+), 84 deletions(-)

diff --git a/NuGet.Config b/NuGet.Config
index 0ea90a3391..028616d733 100644
--- a/NuGet.Config
+++ b/NuGet.Config
@@ -12,6 +12,7 @@
   </solution>
   <packageSources>
     <clear />
+    <add key="source-built" value="E:\code\source-build\bin/obj/x64/Release/source-built/" />
     <add key="dotnet.myget.org dotnet-coreclr" value="https://dotnet.myget.org/F/dotnet-coreclr/api/v3/index.json" />
     <add key="dotnet.myget.org dotnet-core" value="https://dotnet.myget.org/F/dotnet-core/api/v3/index.json" />
     <add key="dotnet.myget.org dotnet-corefxtestdata" value="https://dotnet.myget.org/F/dotnet-corefxtestdata/api/v3/index.json" />
@@ -24,9 +25,9 @@
     <add key="dotnet.myget.org interactive-window" value="https://dotnet.myget.org/F/interactive-window/api/v3/index.json" />
     <add key="dotnet.myget.org roslyn-master-nightly" value="https://dotnet.myget.org/F/roslyn-master-nightly/api/v3/index.json" />
     <add key="dotnet.myget.org devcore" value="https://www.myget.org/F/vs-devcore/api/v3/index.json" />
-    <add key="dotnet.myget.org roslyn-tools" value = "https://dotnet.myget.org/F/roslyn-tools/api/v3/index.json" />
+    <add key="dotnet.myget.org roslyn-tools" value="https://dotnet.myget.org/F/roslyn-tools/api/v3/index.json" />
     <add key="dotnet.myget.org roslyn" value="https://dotnet.myget.org/F/roslyn/api/v3/index.json" />
     <add key="myget.org vs-editor" value="https://myget.org/F/vs-editor/api/v3/index.json" />
     <add key="nuget.org" value="https://api.nuget.org/v3/index.json" />
   </packageSources>
-</configuration>
+</configuration>
\ No newline at end of file
diff --git a/build/Targets/Settings.props b/build/Targets/Settings.props
index 3592746db7..8ce599195e 100644
--- a/build/Targets/Settings.props
+++ b/build/Targets/Settings.props
@@ -141,7 +141,8 @@
   <Import Project="$(RoslynDiagnosticsPropsFilePath)" Condition="'$(UseRoslynAnalyzers)' == 'true' AND Exists('$(RoslynDiagnosticsPropsFilePath)')" />
 
   <ImportGroup Label="WindowsImports" Condition="'$(OS)' == 'Windows_NT'">
-    <Import Project="$(NuGetPackageRoot)\Microsoft.VSSDK.BuildTools\$(VisualStudioBuildToolsVersion)\build\Microsoft.VsSDK.BuildTools.props" />
+    <Import Project="$(NuGetPackageRoot)\Microsoft.VSSDK.BuildTools\$(VisualStudioBuildToolsVersion)\build\Microsoft.VsSDK.BuildTools.props" 
+            Condition="Exists('$(NuGetPackageRoot)\Microsoft.VSSDK.BuildTools\$(VisualStudioBuildToolsVersion)\build\Microsoft.VsSDK.BuildTools.props')" />
   </ImportGroup>
 
   <Import Project="$(ToolsetCompilerPropsFilePath)" Condition="Exists('$(ToolsetCompilerPropsFilePath)') AND '$(BootstrapBuildPath)' == ''" />
diff --git a/src/NuGet/Microsoft.CodeAnalysis.Build.Tasks.nuspec b/src/NuGet/Microsoft.CodeAnalysis.Build.Tasks.nuspec
index fbf3cb52db..f3bf925b32 100644
--- a/src/NuGet/Microsoft.CodeAnalysis.Build.Tasks.nuspec
+++ b/src/NuGet/Microsoft.CodeAnalysis.Build.Tasks.nuspec
@@ -1,6 +1,6 @@
-<?xml version="1.0"?>
+﻿<?xml version="1.0" encoding="utf-8"?>
 <package>
- <metadata minClientVersion="3.3">
+  <metadata minClientVersion="3.3">
     <id>Microsoft.CodeAnalysis.Build.Tasks</id>
     <summary>The build Tasks for running the C# and VB compilers in MSBuild.</summary>
     <description>
@@ -11,27 +11,25 @@
     </description>
     <dependencies>
       <group targetFramework="netstandard1.3">
-        <dependency id="Microsoft.CodeAnalysis.CSharp"                      version="[$version$]" />
-        <dependency id="Microsoft.Build"                                    version="$MicrosoftBuildFixedVersion$" />
-        <dependency id="Microsoft.Build.Tasks.Core"                         version="$MicrosoftBuildTasksCoreFixedVersion$" />
-
-        <dependency id="System.AppContext"                                  version="$SystemAppContextVersion$" />
-        <dependency id="System.Console"                                     version="$SystemConsoleVersion$" />
-        <dependency id="System.Diagnostics.Process"                         version="$SystemDiagnosticsProcessVersion$" />
-        <dependency id="System.Diagnostics.Tools"                           version="$SystemDiagnosticsToolsVersion$"/>
-        <dependency id="System.IO.FileSystem"                               version="$SystemIOFileSystemVersion$"/>
-        <dependency id="System.IO.FileSystem.DriveInfo"                     version="$SystemIOFileSystemDriveInfoVersion$"/>
-        <dependency id="System.IO.Pipes"                                    version="$SystemIOPipesVersion$" />
-        <dependency id="System.Security.AccessControl"                      version="$SystemSecurityAccessControlVersion$" />
-        <dependency id="System.Security.Cryptography.Algorithms"            version="$SystemSecurityCryptographyAlgorithmsVersion$"/>
-        <dependency id="System.Security.Principal.Windows"                  version="$SystemSecurityPrincipalWindowsVersion$" />
-        <dependency id="System.Text.Encoding"                               version="$SystemTextEncodingVersion$"/>
-        <dependency id="System.Text.Encoding.Extensions"                    version="$SystemTextEncodingExtensionsVersion$"/>
-        <dependency id="System.Text.RegularExpressions"                     version="$SystemTextRegularExpressionsVersion$"/>
-        <dependency id="System.Threading.Thread"                            version="$SystemThreadingThreadVersion$" />
+        <dependency id="Microsoft.CodeAnalysis.CSharp" version="[$version$]" />
+        <dependency id="Microsoft.Build" version="$MicrosoftBuildFixedVersion$" />
+        <dependency id="Microsoft.Build.Tasks.Core" version="$MicrosoftBuildTasksCoreFixedVersion$" />
+        <dependency id="System.AppContext" version="$SystemAppContextVersion$" />
+        <dependency id="System.Console" version="$SystemConsoleVersion$" />
+        <dependency id="System.Diagnostics.Process" version="$SystemDiagnosticsProcessVersion$" />
+        <dependency id="System.Diagnostics.Tools" version="$SystemDiagnosticsToolsVersion$" />
+        <dependency id="System.IO.FileSystem" version="$SystemIOFileSystemVersion$" />
+        <dependency id="System.IO.FileSystem.DriveInfo" version="$SystemIOFileSystemDriveInfoVersion$" />
+        <dependency id="System.IO.Pipes" version="$SystemIOPipesVersion$" />
+        <dependency id="System.Security.AccessControl" version="$SystemSecurityAccessControlVersion$" />
+        <dependency id="System.Security.Cryptography.Algorithms" version="$SystemSecurityCryptographyAlgorithmsVersion$" />
+        <dependency id="System.Security.Principal.Windows" version="$SystemSecurityPrincipalWindowsVersion$" />
+        <dependency id="System.Text.Encoding" version="$SystemTextEncodingVersion$" />
+        <dependency id="System.Text.Encoding.Extensions" version="$SystemTextEncodingExtensionsVersion$" />
+        <dependency id="System.Text.RegularExpressions" version="$SystemTextRegularExpressionsVersion$" />
+        <dependency id="System.Threading.Thread" version="$SystemThreadingThreadVersion$" />
       </group>
     </dependencies>
-
     <language>en-US</language>
     <requireLicenseAcceptance>true</requireLicenseAcceptance>
     <version>$version$</version>
@@ -41,9 +39,8 @@
     <releaseNotes>$releaseNotes$</releaseNotes>
     <tags>$tags$</tags>
     <serviceable>true</serviceable>
-
     <contentFiles>
-      <files include="**/*.targets" buildAction="None" copyToOutput="true" />
+      <files include="**\*.targets" buildAction="None" copyToOutput="true" />
     </contentFiles>
   </metadata>
   <files>
@@ -52,4 +49,4 @@
     <file src="Dlls\MSBuildTask\Microsoft.VisualBasic.Core.targets" target="contentFiles\any\any" />
     <file src="$thirdPartyNoticesPath$" target="" />
   </files>
-</package>
+</package>
\ No newline at end of file
diff --git a/src/NuGet/Microsoft.CodeAnalysis.CSharp.nuspec b/src/NuGet/Microsoft.CodeAnalysis.CSharp.nuspec
index d1034e394e..6ae47a5d0f 100644
--- a/src/NuGet/Microsoft.CodeAnalysis.CSharp.nuspec
+++ b/src/NuGet/Microsoft.CodeAnalysis.CSharp.nuspec
@@ -1,4 +1,4 @@
-<?xml version="1.0"?>
+﻿<?xml version="1.0" encoding="utf-8"?>
 <package xmlns="http://schemas.microsoft.com/packaging/2011/08/nuspec.xsd">
   <metadata minClientVersion="3.3">
     <id>Microsoft.CodeAnalysis.CSharp</id>
@@ -11,7 +11,6 @@
     <dependencies>
       <dependency id="Microsoft.CodeAnalysis.Common" version="[$version$]" />
     </dependencies>
-
     <language>en-US</language>
     <requireLicenseAcceptance>true</requireLicenseAcceptance>
     <version>$version$</version>
@@ -27,4 +26,4 @@
     <file src="Dlls\CSharpCodeAnalysis\Microsoft.CodeAnalysis.CSharp.xml" target="lib\netstandard1.3" />
     <file src="$thirdPartyNoticesPath$" target="" />
   </files>
-</package>
+</package>
\ No newline at end of file
diff --git a/src/NuGet/Microsoft.CodeAnalysis.Common.nuspec b/src/NuGet/Microsoft.CodeAnalysis.Common.nuspec
index a3f8409a57..b87bba40cc 100644
--- a/src/NuGet/Microsoft.CodeAnalysis.Common.nuspec
+++ b/src/NuGet/Microsoft.CodeAnalysis.Common.nuspec
@@ -1,4 +1,4 @@
-<?xml version="1.0"?>
+﻿<?xml version="1.0" encoding="utf-8"?>
 <package xmlns="http://schemas.microsoft.com/packaging/2011/08/nuspec.xsd">
   <metadata minClientVersion="3.3">
     <id>Microsoft.CodeAnalysis.Common</id>
@@ -10,49 +10,47 @@
     </description>
     <dependencies>
       <group targetFramework="netstandard1.3">
-        <dependency id="Microsoft.CodeAnalysis.Analyzers"              version="$MicrosoftCodeAnalysisAnalyzersVersion$" />
-
-        <dependency id="System.AppContext"                             version="$SystemAppContextVersion$"/>
-        <dependency id="System.Collections"                            version="$SystemCollectionsVersion$"/>
-        <dependency id="System.Collections.Concurrent"                 version="$SystemCollectionsConcurrentVersion$"/>
-        <dependency id="System.Collections.Immutable"                  version="$SystemCollectionsImmutableVersion$"/>
-        <dependency id="System.Console"                                version="$SystemConsoleVersion$"/>
-        <dependency id="System.Diagnostics.Debug"                      version="$SystemDiagnosticsDebugVersion$"/>
-        <dependency id="System.Diagnostics.FileVersionInfo"            version="$SystemDiagnosticsFileVersionInfoVersion$" exclude="Compile" />
-        <dependency id="System.Diagnostics.StackTrace"                 version="$SystemDiagnosticsStackTraceVersion$" exclude="Compile" />
-        <dependency id="System.Diagnostics.Tools"                      version="$SystemDiagnosticsToolsVersion$"/>
-        <dependency id="System.Dynamic.Runtime"                        version="$SystemDynamicRuntimeVersion$"/>
-        <dependency id="System.Globalization"                          version="$SystemGlobalizationVersion$"/>
-        <dependency id="System.IO.Compression"                         version="$SystemIOCompressionVersion$" />
-        <dependency id="System.IO.FileSystem"                          version="$SystemIOFileSystemVersion$"/>
-        <dependency id="System.IO.FileSystem.Primitives"               version="$SystemIOFileSystemPrimitivesVersion$"/>
-        <dependency id="System.Linq"                                   version="$SystemLinqVersion$"/>
-        <dependency id="System.Linq.Expressions"                       version="$SystemLinqExpressionsVersion$"/>
-        <dependency id="System.Reflection"                             version="$SystemReflectionVersion$"/>
-        <dependency id="System.Reflection.Metadata"                    version="$SystemReflectionMetadataVersion$"/>
-        <dependency id="System.Resources.ResourceManager"              version="$SystemResourcesResourceManagerVersion$"/>
-        <dependency id="System.Runtime"                                version="$SystemRuntimeVersion$"/>
-        <dependency id="System.Runtime.Extensions"                     version="$SystemRuntimeExtensionsVersion$"/>
-        <dependency id="System.Runtime.InteropServices"                version="$SystemRuntimeInteropServicesVersion$"/>
-        <dependency id="System.Runtime.Numerics"                       version="$SystemRuntimeNumericsVersion$"/>
-        <dependency id="System.Security.Cryptography.Algorithms"       version="$SystemSecurityCryptographyAlgorithmsVersion$"/>
-        <dependency id="System.Security.Cryptography.Encoding"         version="$SystemSecurityCryptographyEncodingVersion$"/>
-        <dependency id="System.Security.Cryptography.X509Certificates" version="$SystemSecurityCryptographyX509CertificatesVersion$"/>
-        <dependency id="System.Text.Encoding"                          version="$SystemTextEncodingVersion$"/>
-        <dependency id="System.Text.Encoding.CodePages"                version="$SystemTextEncodingCodePagesVersion$" exclude="Compile" />
-        <dependency id="System.Text.Encoding.Extensions"               version="$SystemTextEncodingExtensionsVersion$"/>
-        <dependency id="System.Threading"                              version="$SystemThreadingVersion$" exclude="Compile" />
-        <dependency id="System.Threading.Tasks"                        version="$SystemThreadingTasksVersion$"/>
-        <dependency id="System.Threading.Tasks.Parallel"               version="$SystemThreadingTasksParallelVersion$"/>
-        <dependency id="System.Threading.Thread"                       version="$SystemThreadingThreadVersion$" exclude="Compile" />
-        <dependency id="System.ValueTuple"                             version="$SystemValueTupleVersion$" />
-        <dependency id="System.Xml.ReaderWriter"                       version="$SystemXmlReaderWriterVersion$"/>
-        <dependency id="System.Xml.XDocument"                          version="$SystemXmlXDocumentVersion$"/>
-        <dependency id="System.Xml.XmlDocument"                        version="$SystemXmlXmlDocumentVersion$" exclude="Compile" />
-        <dependency id="System.Xml.XPath.XDocument"                    version="$SystemXmlXPathXDocumentVersion$" exclude="Compile" />
+        <dependency id="Microsoft.CodeAnalysis.Analyzers" version="$MicrosoftCodeAnalysisAnalyzersVersion$" />
+        <dependency id="System.AppContext" version="$SystemAppContextVersion$" />
+        <dependency id="System.Collections" version="$SystemCollectionsVersion$" />
+        <dependency id="System.Collections.Concurrent" version="$SystemCollectionsConcurrentVersion$" />
+        <dependency id="System.Collections.Immutable" version="$SystemCollectionsImmutableVersion$" />
+        <dependency id="System.Console" version="$SystemConsoleVersion$" />
+        <dependency id="System.Diagnostics.Debug" version="$SystemDiagnosticsDebugVersion$" />
+        <dependency id="System.Diagnostics.FileVersionInfo" version="$SystemDiagnosticsFileVersionInfoVersion$" exclude="Compile" />
+        <dependency id="System.Diagnostics.StackTrace" version="$SystemDiagnosticsStackTraceVersion$" exclude="Compile" />
+        <dependency id="System.Diagnostics.Tools" version="$SystemDiagnosticsToolsVersion$" />
+        <dependency id="System.Dynamic.Runtime" version="$SystemDynamicRuntimeVersion$" />
+        <dependency id="System.Globalization" version="$SystemGlobalizationVersion$" />
+        <dependency id="System.IO.Compression" version="$SystemIOCompressionVersion$" />
+        <dependency id="System.IO.FileSystem" version="$SystemIOFileSystemVersion$" />
+        <dependency id="System.IO.FileSystem.Primitives" version="$SystemIOFileSystemPrimitivesVersion$" />
+        <dependency id="System.Linq" version="$SystemLinqVersion$" />
+        <dependency id="System.Linq.Expressions" version="$SystemLinqExpressionsVersion$" />
+        <dependency id="System.Reflection" version="$SystemReflectionVersion$" />
+        <dependency id="System.Reflection.Metadata" version="$SystemReflectionMetadataVersion$" />
+        <dependency id="System.Resources.ResourceManager" version="$SystemResourcesResourceManagerVersion$" />
+        <dependency id="System.Runtime" version="$SystemRuntimeVersion$" />
+        <dependency id="System.Runtime.Extensions" version="$SystemRuntimeExtensionsVersion$" />
+        <dependency id="System.Runtime.InteropServices" version="$SystemRuntimeInteropServicesVersion$" />
+        <dependency id="System.Runtime.Numerics" version="$SystemRuntimeNumericsVersion$" />
+        <dependency id="System.Security.Cryptography.Algorithms" version="$SystemSecurityCryptographyAlgorithmsVersion$" />
+        <dependency id="System.Security.Cryptography.Encoding" version="$SystemSecurityCryptographyEncodingVersion$" />
+        <dependency id="System.Security.Cryptography.X509Certificates" version="$SystemSecurityCryptographyX509CertificatesVersion$" />
+        <dependency id="System.Text.Encoding" version="$SystemTextEncodingVersion$" />
+        <dependency id="System.Text.Encoding.CodePages" version="$SystemTextEncodingCodePagesVersion$" exclude="Compile" />
+        <dependency id="System.Text.Encoding.Extensions" version="$SystemTextEncodingExtensionsVersion$" />
+        <dependency id="System.Threading" version="$SystemThreadingVersion$" exclude="Compile" />
+        <dependency id="System.Threading.Tasks" version="$SystemThreadingTasksVersion$" />
+        <dependency id="System.Threading.Tasks.Parallel" version="$SystemThreadingTasksParallelVersion$" />
+        <dependency id="System.Threading.Thread" version="$SystemThreadingThreadVersion$" exclude="Compile" />
+        <dependency id="System.ValueTuple" version="$SystemValueTupleVersion$" />
+        <dependency id="System.Xml.ReaderWriter" version="$SystemXmlReaderWriterVersion$" />
+        <dependency id="System.Xml.XDocument" version="$SystemXmlXDocumentVersion$" />
+        <dependency id="System.Xml.XmlDocument" version="$SystemXmlXmlDocumentVersion$" exclude="Compile" />
+        <dependency id="System.Xml.XPath.XDocument" version="$SystemXmlXPathXDocumentVersion$" exclude="Compile" />
       </group>
     </dependencies>
-
     <language>en-US</language>
     <requireLicenseAcceptance>true</requireLicenseAcceptance>
     <version>$version$</version>
@@ -68,4 +66,4 @@
     <file src="Dlls\CodeAnalysis\Microsoft.CodeAnalysis.xml" target="lib\netstandard1.3" />
     <file src="$thirdPartyNoticesPath$" target="" />
   </files>
-</package>
+</package>
\ No newline at end of file
diff --git a/src/NuGet/Microsoft.CodeAnalysis.Compilers.nuspec b/src/NuGet/Microsoft.CodeAnalysis.Compilers.nuspec
index d4534fd985..786111ee65 100644
--- a/src/NuGet/Microsoft.CodeAnalysis.Compilers.nuspec
+++ b/src/NuGet/Microsoft.CodeAnalysis.Compilers.nuspec
@@ -1,4 +1,4 @@
-<?xml version="1.0"?>
+﻿<?xml version="1.0" encoding="utf-8"?>
 <package xmlns="http://schemas.microsoft.com/packaging/2011/08/nuspec.xsd">
   <metadata minClientVersion="3.3">
     <id>Microsoft.CodeAnalysis.Compilers</id>
@@ -14,7 +14,6 @@
       <dependency id="Microsoft.CodeAnalysis.CSharp" version="[$version$]" />
       <dependency id="Microsoft.CodeAnalysis.VisualBasic" version="[$version$]" />
     </dependencies>
-
     <language>en-US</language>
     <requireLicenseAcceptance>true</requireLicenseAcceptance>
     <version>$version$</version>
@@ -28,4 +27,4 @@
   <files>
     <file src="$thirdPartyNoticesPath$" target="" />
   </files>
-</package>
+</package>
\ No newline at end of file
diff --git a/src/NuGet/Microsoft.CodeAnalysis.VisualBasic.nuspec b/src/NuGet/Microsoft.CodeAnalysis.VisualBasic.nuspec
index 2fc48064ee..35c0fc14c6 100644
--- a/src/NuGet/Microsoft.CodeAnalysis.VisualBasic.nuspec
+++ b/src/NuGet/Microsoft.CodeAnalysis.VisualBasic.nuspec
@@ -1,4 +1,4 @@
-<?xml version="1.0"?>
+﻿<?xml version="1.0" encoding="utf-8"?>
 <package xmlns="http://schemas.microsoft.com/packaging/2011/08/nuspec.xsd">
   <metadata minClientVersion="3.3">
     <id>Microsoft.CodeAnalysis.VisualBasic</id>
@@ -11,7 +11,6 @@
     <dependencies>
       <dependency id="Microsoft.CodeAnalysis.Common" version="$version$" />
     </dependencies>
-
     <language>en-US</language>
     <requireLicenseAcceptance>true</requireLicenseAcceptance>
     <version>$version$</version>
@@ -27,4 +26,4 @@
     <file src="Dlls\BasicCodeAnalysis\Microsoft.CodeAnalysis.VisualBasic.xml" target="lib\netstandard1.3" />
     <file src="$thirdPartyNoticesPath$" target="" />
   </files>
-</package>
+</package>
\ No newline at end of file
diff --git a/src/NuGet/Microsoft.Net.Compilers.netcore.nuspec b/src/NuGet/Microsoft.Net.Compilers.netcore.nuspec
index c6c2bc3f94..8a4361669c 100644
--- a/src/NuGet/Microsoft.Net.Compilers.netcore.nuspec
+++ b/src/NuGet/Microsoft.Net.Compilers.netcore.nuspec
@@ -1,4 +1,4 @@
-<?xml version="1.0"?>
+﻿<?xml version="1.0" encoding="utf-8"?>
 <package xmlns="http://schemas.microsoft.com/packaging/2011/08/nuspec.xsd">
   <metadata>
     <id>Microsoft.Net.Compilers.netcore</id>
@@ -29,8 +29,8 @@
     </dependencies>
   </metadata>
   <files>
-    <file src="$emptyDirPath$/_._" target="ref/netcoreapp1.0" />
-    <file src="Exes/CscCore/csc.dll" target="runtimes/any/native" />
-    <file src="Exes/VbcCore/vbc.dll" target="runtimes/any/native" />
+    <file src="$emptyDirPath$\_._" target="ref\netcoreapp1.0" />
+    <file src="Exes\CscCore\csc.dll" target="runtimes\any\native" />
+    <file src="Exes\VbcCore\vbc.dll" target="runtimes\any\native" />
   </files>
-</package>
+</package>
\ No newline at end of file
-- 
2.14.1.windows.1

